# فعال سازی تانل میکروتیک به اوبونتو با GRE (IPv4 &amp; IPv6)

از همان ابتدای کار فایلی رو ایجاد میکنیم که در داخل آن دستورات قرار گرفته و پس از ذخیره سازی خودکار فایل اجرا میشود و دستورات در سرور مدنظر اعمال خواهد شد و زمانی که سیستم ریستارت میشود هم این فایل دوباره خودکار اجرا و تانل ایجاد میشود.

**1. سرور خارج (اوبونتو)**
- ابتدا با دستور زیر فایل `rc.local` رو ایجاد میکنیم و بهش اجازه دسترسی بعد از هر بار ریستارت شدن سرور رو میدهیم به این صورت بعد از ریستارت شدن سرور دستورات پاک نمیشوند.
```shell
sudo nano /etc/rc.local && sudo chmod +x /etc/rc.local && sudo bash /etc/rc.local
```
متن زیر را در فایل قرار میدیم و فایل رو ذخیره میکنیم و سپس بعد از ذخیره فایل دستورات خودکار اجرا میشوند.
>نکته : (در قسمت `[IPv4-IRAN]` ، آیپی ورژن 4 پابلیک سرور ایران رو قرار میدیم و در بخش `[IPv4-KHAREJ]` ، آیپی ورژن 4 پابلیک خارج رو قرار میدیم)
```shell
#!/bin/bash
sudo ip tunnel add gre1 mode gre remote [IPv4-IRAN] local [IPv4-KHAREJ] ttl 255
sudo ip link set gre1 mtu 1420
sudo ip link set gre1 up
sudo ip addr add 10.10.10.2/30 dev gre1
nohup ping 10.10.10.1 &

exit 0
```
**2. سرور ایران (میکروتیک)**

وارد ترمینال میکروتیک بشین و دستورات زیر را وارد کنید تا خودکار اینترفیس تانل و آیپی آدرس داخلی رو ایجاد کند.
>نکته : (در این قسمت هم `[IPv4-IRAN]` ، آیپی ورژن 4 پابلیک سرور ایران رو قرار میدیم و در بخش `[IPv4-KHAREJ]` ، آیپی ورژن 4 پابلیک خارج رو قرار میدیم)

```shell
/interface gre add name=gre1 local-address=[IPv4-IRAN] remote-address=[IPv4-KHAREJ] mtu=1420
/ip address add address=10.10.10.1/30 interface=gre1
```
تتانل GRE بین دو سرور خارج و ایران برقرار شده و در کنار اینترفیس میکروتیک کلمه R (RUN) رو مشاهده میکنید که به این معنی که تانل اجرا شده.

 - آیپی v4 داخلی سرور ایران : 10.10.10.1
 - آیپی v4 داخلی سرور خارج : 10.10.10.2

برای اطمینان از اینکه تانل برقرار شده باشه وارد هر دو سرور بشید و از آیپی داخلی سرور مقابل پینگ بگیرید.
- به عنوان مثل وارد سرور ایران میشیم و با دستور زیر آیپی v4 داخلی سرور خارج رو روی ایران پینگ میگیرم : 
```shell
ping 10.10.10.2
```
- روی سرور خارچ نیز با دستور زیر آیپی v4 داخلی سرور ایران رو روی خارج پینگ میگیرم :
```shell
ping 10.10.10.1
```
اگر دستورات رو به صورت صحیح وارد کرده باشین هر دو سرور پینگ مقابل همدیگر رو میبینند.

# ارسال ترافیک ورودی سرور میکروتیک به سرور مقصد
برای انتقال ترافیک بر روی تانل وارد ترمینال میکروتیک بشین و دستورات زیر رو وارد کنید.
>توجه: اگر پورت `winbox` میکروتیک شما عددی غیر از `8291` پیشفرض هستش حتما قبل از وارد کردن دستور زیر مقدار `dst-port` رو به عدد پورت `winbox` خودتون تغییر بدین که تمام ترافیک ورودی سرور به جز پورت `winbox` به سرور مقصد ارسال شود.
```shell
/ip firewall nat add chain=srcnat action=masquerade
/ip firewall nat add chain=dstnat protocol=tcp dst-port=!8291 action=dst-nat to-addresses=10.10.10.2
```
